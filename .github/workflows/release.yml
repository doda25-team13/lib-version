# name: Release lib-version F2

# on:
#   push:
#     tags:
#       - "v*"

# jobs:
#   build-and-publish:
#     runs-on: ubuntu-latest

#     permissions:
#       contents: write
#       packages: write

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up JDK
#         uses: actions/setup-java@v4
#         with:
#           distribution: temurin
#           java-version: 21
#           cache: 'maven'
#           server-id: github
#           settings-path: ${{ github.workspace }}

#       - name: Build with Maven
#         run: mvn -B clean package

#       - name: Publish to GitHub Packages
#         env:
#           GITHUB_TOKEN: ${{ github.token }}
#         run: mvn -B deploy -s $GITHUB_WORKSPACE/settings.xml -DskipTests

name: Stable Release (lib-version) F11

on:
  push:
    tags: ["v[0-9]+.[0-9]+.[0-9]+"]

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: f11-releases

      - name: Set up Java + Maven server
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Read version from tag
        shell: bash
        run: |
          REL="${GITHUB_REF#refs/tags/v}"
          echo "RELEASE_VERSION=$REL" >> "$GITHUB_ENV"

      - name: Set pom.xml to stable version
        run: |
          mvn -B versions:set -DnewVersion="${RELEASE_VERSION}"
          mvn -B versions:commit

      - name: Deploy stable release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          mvn -B -s "${GITHUB_WORKSPACE}/settings.xml" deploy -DskipTests

      - name: Compute next SNAPSHOT (patch + 1)
        shell: bash
        run: |
          IFS='.' read -r MA MI PA <<< "${RELEASE_VERSION}"
          NEXT_PA=$((PA + 1))
          NEXT="${MA}.${MI}.${NEXT_PA}-SNAPSHOT"
          echo "NEXT_SNAPSHOT=$NEXT" >> "$GITHUB_ENV"

      - name: Bump pom.xml to next SNAPSHOT
        run: |
          mvn -B versions:set -DnewVersion="${NEXT_SNAPSHOT}"
          mvn -B versions:commit

      - name: Commit and push SNAPSHOT bump to main
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add pom.xml
          git commit -m "chore: bump version to ${NEXT_SNAPSHOT}"
          git push origin main


name: Stable Release (lib-version) F11

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Next version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  packages: write

jobs:
  release:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Set up Java + Maven server
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Configure Git user
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Prepare stable version (commit + tag)
        shell: bash
        run: |
          set -euo pipefail

          CURRENT=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "Current pom.xml version: $CURRENT"

          # Only release if main is on a SNAPSHOT version
          case "$CURRENT" in
            *-SNAPSHOT) ;;
            *)
              echo "Not a SNAPSHOT version ($CURRENT) â€” skipping release."
              exit 0
              ;;
          esac

          mvn -B versions:set -DremoveSnapshot -DgenerateBackupPoms=false
          mvn -B versions:commit

          RELEASE_VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "Release version: $RELEASE_VERSION"
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> "$GITHUB_ENV"

          # Fail if tag already exists
          if git rev-parse "v$RELEASE_VERSION" >/dev/null 2>&1; then
            echo "Tag v$RELEASE_VERSION already exists"
            exit 1
          fi

          git add pom.xml
          git commit -m "chore: release v$RELEASE_VERSION [skip ci]"
          git tag "v$RELEASE_VERSION"

      - name: Deploy stable release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          mvn -B -s "${GITHUB_WORKSPACE}/settings.xml" deploy -DskipTests

      - name: Bump to next SNAPSHOT
        shell: bash
        run: |
          set -euo pipefail
          
          BUMP_TYPE="${{ github.event.inputs.bump_type }}"
          
          # Default to 'patch' if triggered automatically (push event)
          if [ -z "$BUMP_TYPE" ]; then
            BUMP_TYPE="patch"
          fi
          
          echo "Bumping version using type: $BUMP_TYPE"

          # Use build-helper-maven-plugin to calculate the next version
          case "$BUMP_TYPE" in
            major)
              mvn build-helper:parse-version versions:set \
                -DnewVersion=\${parsedVersion.nextMajorVersion}.0.0-SNAPSHOT \
                -DgenerateBackupPoms=false
              ;;
            minor)
              mvn build-helper:parse-version versions:set \
                -DnewVersion=\${parsedVersion.majorVersion}.\${parsedVersion.nextMinorVersion}.0-SNAPSHOT \
                -DgenerateBackupPoms=false
              ;;
            patch)
              mvn build-helper:parse-version versions:set \
                -DnewVersion=\${parsedVersion.majorVersion}.\${parsedVersion.minorVersion}.\${parsedVersion.nextIncrementalVersion}-SNAPSHOT \
                -DgenerateBackupPoms=false
              ;;
            *)
              echo "Unknown bump type: $BUMP_TYPE"
              exit 1
              ;;
          esac

          mvn -B versions:commit
          
          NEXT_SNAPSHOT=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "Next SNAPSHOT version: $NEXT_SNAPSHOT"

          git add pom.xml
          git commit -m "chore: bump version to ${NEXT_SNAPSHOT} [skip ci]"

      - name: Push commits and tag
        run: |
          git push --atomic origin main "v${RELEASE_VERSION}"




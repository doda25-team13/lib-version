# name: Release lib-version F2

# on:
#   push:
#     tags:
#       - "v*"

# jobs:
#   build-and-publish:
#     runs-on: ubuntu-latest

#     permissions:
#       contents: write
#       packages: write

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up JDK
#         uses: actions/setup-java@v4
#         with:
#           distribution: temurin
#           java-version: 21
#           cache: 'maven'
#           server-id: github
#           settings-path: ${{ github.workspace }}

#       - name: Build with Maven
#         run: mvn -B clean package

#       - name: Publish to GitHub Packages
#         env:
#           GITHUB_TOKEN: ${{ github.token }}
#         run: mvn -B deploy -s $GITHUB_WORKSPACE/settings.xml -DskipTests

name: Stable Release (lib-version) F11

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write

jobs:
  release:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Set up Java + Maven server
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Configure Git user
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Prepare stable version (commit + tag)
        shell: bash
        run: |
          set -euo pipefail

          CURRENT=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "Current pom.xml version: $CURRENT"

          # Only release if main is on a SNAPSHOT version
          case "$CURRENT" in
            *-SNAPSHOT) ;;
            *)
              echo "Not a SNAPSHOT version ($CURRENT) â€” skipping release."
              exit 0
              ;;
          esac

          mvn -B versions:set -DremoveSnapshot -DgenerateBackupPoms=false
          mvn -B versions:commit

          RELEASE_VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "Release version: $RELEASE_VERSION"
          echo "RELEASE_VERSION=$RELEASE_VERSION" >> "$GITHUB_ENV"

          # Fail if tag already exists
          if git rev-parse "v$RELEASE_VERSION" >/dev/null 2>&1; then
            echo "Tag v$RELEASE_VERSION already exists"
            exit 1
          fi

          git add pom.xml
          git commit -m "chore: release v$RELEASE_VERSION [skip ci]"
          git tag "v$RELEASE_VERSION"

      - name: Deploy stable release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          mvn -B -s "${GITHUB_WORKSPACE}/settings.xml" deploy -DskipTests

      - name: Bump to next SNAPSHOT (patch + 1)
        shell: bash
        run: |
          set -euo pipefail

          IFS='.' read -r MA MI PA <<< "${RELEASE_VERSION}"
          NEXT_PA=$((PA + 1))
          NEXT_SNAPSHOT="${MA}.${MI}.${NEXT_PA}-SNAPSHOT"
          echo "Next SNAPSHOT: $NEXT_SNAPSHOT"
          echo "NEXT_SNAPSHOT=$NEXT_SNAPSHOT" >> "$GITHUB_ENV"

          mvn -B versions:set -DnewVersion="${NEXT_SNAPSHOT}" -DgenerateBackupPoms=false
          mvn -B versions:commit

          git add pom.xml
          git commit -m "chore: bump version to ${NEXT_SNAPSHOT} [skip ci]"

      - name: Push commits and tag
        run: |
          git push --atomic origin main "v${RELEASE_VERSION}"



